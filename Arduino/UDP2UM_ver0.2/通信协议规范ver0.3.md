# 通信协议ver0.3

>   通信协议3.0

## 1.1 说明暂留位



## 1.2 MCU对WiFi模块通信 - SPI

>   本部分内容详细描述单片机到WiFi模块的通信

### 1.2.1 通信内容格式

SPI通信具体内容格式如下：

| 指令位\|地址寄存器 | 通信指示<br />INSTRUCTION | 编号<br />NUMBER | 通信内容   |
| ------------------ | ------------------------- | ---------------- | ---------- |
| 0x0200             | 8 bit                     | 8 bit            | 30 * 8 bit |

-   **指令位|寄存器位**

根据ESP8266 SPI从机通信格式规定，前16位必须是指令位|地址寄存器，其中指令位`0x02`为向从机写数据。

>   指令位`0x04`为读取从机状态寄存器数值。指令位`0x01`为向从机状态寄存器写数值。详见ESP8266技术手册`44/108页`

-   **通信指示**

通信指示用以表示当前次通信的目的，可以是`开始通信`、`通信进行中`、`通信结束`等

-   **编号**

编号可以表示本次通信进行的次数。单次SPI通信能传输的数据上限是`32字节`（由ESP8266 - Arduino库决定），编号的加入方便验证全局通信是否有遗漏部分

-   **通信内容**

本次通信的内容，由于通信指示|编号占用了`2字节`，所以剩下`30字节`用于传输数据内容

### 1.2.2 规定好的通信

以下是由**吉平_集**规定的通信规则

| 枚举名称             | 通信指示 | 指示含义        | 补充                                                       |
| -------------------- | -------- | --------------- | ---------------------------------------------------------- |
| SPI_COMN             | 0xAx     | SPI通信相关     |                                                            |
| SPI_COMN_START       | 0xA0     | 开始通信        |                                                            |
| SPI_COMN_UNDERWAY    | 0xA1     | 通信进行中      |                                                            |
| SPI_COMN_END         | 0xA2     | 通信结束        |                                                            |
| WIFI_INFO_SET        | 0xCx     | 设置WIFI信息    |                                                            |
| WIFI_SET_NAME        | 0xC0     | 设置WiFi名称    | 名称长度超过30字节会出问题，如果有中文，编码也有可能出问题 |
| WIFI_SET_PASSWORD    | 0xC1     | 设置WiFi密码    |                                                            |
| WIFI_SET_IP          | 0xC2     | 指定发送IP      |                                                            |
| WIFI_SET_SENDPORT    | 0xC3     | 指定UDP发送端口 | 默认9000                                                   |
| WIFI_SET_RECEIVEPORT | 0xC4     | 指定UDP读取端口 | 默认8000                                                   |
| WIFI_INITIALIZATION  | 0xD0     | 指示WiFi初始化  | 未指定参数为默认值                                         |

## 1.3 WiFi模块对上位机通信 - UDP

WiFI对上位机通信的内容包括两部分：

| 数据传输长度 | 传输内容                                                     |
| ------------ | ------------------------------------------------------------ |
| 2个字节      | 最大UDP_ONECUT_LEN*UDP_MAX_TIMES个字节<br />单次发送UDP_ONECUT_LEN个字节，最多发UDP_MAX_TIMES次 |

规定通信方式如下：

在每次发送数据前，会先发送2个字节的**数据传输长度**告知上位机即将发起通信。上位机得知通信发起后根据长度记录对应次数的数据

WiFI模块在传输数据时单次发送UDP_ONECUT_LEN个字节的数据，最多发送UDP_MAX_TIMES次数据

以下是由**吉平_集**规定的通信规则

| 枚举名称       | 含义                      | 规定数值 |
| -------------- | ------------------------- | -------- |
| UDP_ONECUT_LEN | UDP通信单次发送的数据长度 | 1120     |
| UDP_MAX_TIMES  | UDP通信最大发送次数       | 4        |

## 1.4 MCU对上位机通信